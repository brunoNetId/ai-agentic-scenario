- route:
    id: main
    from:
      uri: platform-http:/camel/chat
      steps:
        - setVariable:
            id: setVariable-1515
            expression:
              simple:
                expression: ${body}
            name: user-message
        - bean:
            id: bean-1006
            method: reset
            ref: logger
        - setBody:
            id: setBody-1565
            disabled: true
            expression:
              simple:
                expression: Find all the PDF documents from January 2024 to July. For each one
                  of the documents extract the name and surname metadata, and
                  then create an entry in the database using the metadata
                  obtained.
        - to:
            id: to-2813
            uri: direct
            parameters:
              name: getPlan
        - choice:
            id: choice-1272
            otherwise:
              id: otherwise-2209
              steps:
                - log:
                    id: log-1430
                    message: ${body}
            when:
              - id: when-3589
                steps:
                  - log:
                      id: log-1426
                      disabled: true
                      message: only 1 action
                  - setBody:
                      id: setBody-8300
                      disabled: true
                      expression:
                        simple:
                          expression: ${variable.user-message}
                  - log:
                      id: log-4163
                      disabled: true
                      message: "run agent with raw request: ${body}"
                  - log:
                      id: log-4063
                      disabled: true
                      message: "again: ${body}"
                  - to:
                      id: to-9760
                      uri: direct
                      parameters:
                        name: run-agent
                      variableSend: user-message
                  - stop:
                      id: stop-2574
                expression:
                  jq:
                    expression: .steps | length == 1
        - loop:
            id: loop-3272
            steps:
              - setBody:
                  id: setBody-3170
                  expression:
                    jq:
                      expression: .[property("CamelLoopIndex")|tonumber]
                      source: plan
              - to:
                  id: to-4862
                  uri: direct
                  parameters:
                    name: run-step
            expression:
              jq:
                expression: length
                source: plan
        - bean:
            id: bean-3659
            disabled: false
            method: log("job done")
            ref: logger
        - to:
            id: to-1434
            uri: log
            parameters:
              loggerName: InfoLogger
              showAll: true
            disabled: false
        - setBody:
            id: setBody-4095
            expression:
              simple:
                expression: |-
                  ${body}

                  activity: ${bean:logger.getActivity}
        - to:
            id: to-3596
            uri: direct
            parameters:
              name: plan-summary
            variableSend: results
- route:
    id: get-plan
    from:
      id: from-3183
      uri: direct
      parameters:
        name: getPlan
      steps:
        - log:
            id: log-1973
            message: ${body}
        - process:
            description: AI message
            disabled: false
            ref: createChatMessagePlanner
        - to:
            id: to-1802
            uri: langchain4j-chat
            parameters:
              chatId: myllm
              chatModel: "#chatModelPlanner"
              chatOperation: CHAT_MULTIPLE_MESSAGES
            disabled: false
        - log:
            message: ${body}
        - stop:
            id: stop-3687
            disabled: true
        - setVariable:
            id: setVariable-8683
            expression:
              jq:
                expression: .steps
            name: plan
        - setVariable:
            id: setVariable-1645
            description: initialise results
            expression:
              simple:
                expression: "[]"
            name: results
- route:
    id: run-step
    from:
      id: from-3060
      uri: direct
      parameters:
        name: run-step
      steps:
        - setVariable:
            id: setVariable-3746
            expression:
              jq:
                expression: .dependencies[0]
            name: deps
        - log:
            id: log-1115
            message: "deps: ${variable.deps} payload: ${body}"
        - setBody:
            id: setBody-2510
            expression:
              simple:
                expression: ${jq(.description)}
        - setProperty:
            id: setProperty-1934
            expression:
              simple:
                expression: ${body}
            name: thisstep
        - choice:
            id: choice-2397
            when:
              - id: when-2677
                steps:
                  - setBody:
                      id: setBody-2691
                      disabled: true
                      expression:
                        simple:
                          expression: |-
                            ${body}

                            inputs:
                            ${variable.output-${variable.deps}}
                  - setBody:
                      id: setBody-3759
                      expression:
                        simple:
                          expression: |-
                            ${body}

                            inputs:
                            ${variable.results}
                  - setProperty:
                      id: setProperty-1634
                      expression:
                        simple:
                          expression: ${variable.output-${variable.deps}}
                      name: thisinputs
                expression:
                  simple:
                    expression: ${variable.deps} != null
        - to:
            id: to-2112
            uri: direct
            parameters:
              name: run-agent
        - process:
            description: AI message
            disabled: true
            ref: createToolMessage
        - to:
            id: to-1180
            uri: langchain4j-tools
            parameters:
              tags: orchestrator
              toolId: runstep
            disabled: true
        - setVariable:
            id: setVariable-8543
            expression:
              simple:
                expression: ${body}
            name: output-${exchangeProperty.CamelLoopIndex}
        - setProperty:
            id: setProperty-3275
            expression:
              simple:
                expression: ${body}
            name: thisresult
        - setVariable:
            id: setVariable-3883
            description: store result
            expression:
              jq:
                expression: |-
                  . + [{
                    "id": property("CamelLoopIndex"), 
                    "request": property("thisstep"),
                    "inputs": property("thisinputs"),
                    "result": property("thisresult")
                  }]
                source: results
            name: results
        - log:
            id: log-2670
            message: "var is: ${variable.output-${exchangeProperty.CamelLoopIndex}}"
- route:
    id: route-2918
    description: plan summary
    from:
      uri: direct
      parameters:
        name: plan-summary
      steps:
        - log:
            message: ${body}
        - process:
            description: AI message
            disabled: false
            ref: createChatMessagePlanSummary
        - to:
            uri: langchain4j-chat
            parameters:
              chatId: myllm
              chatModel: "#chatModelPlanner"
              chatOperation: CHAT_MULTIPLE_MESSAGES
            disabled: false
        - log:
            message: "plan summary:${body}\\n\\nExecution: ${variable.results}"
        - log:
            message: "activity: ${bean:logger.getActivity}"
- route:
    id: route-3711
    from:
      id: from-2103
      uri: timer
      parameters:
        period: "1000"
        repeatCount: "1"
        timerName: template
      steps:
        - setVariable:
            id: setVariable-7487
            expression:
              simple:
                expression: "[]"
            name: mydata
        - setVariable:
            id: setVariable-6976
            expression:
              jq:
                expression: '. + [{"response1": "backend response"}]'
                source: mydata
            name: mydata
        - to:
            id: to-3487
            uri: direct
            parameters:
              name: testsend
            variableSend: mydata
        - log:
            id: log-2734
            message: ${variable.mydata}
- route:
    id: route-5585
    from:
      id: from-8463
      uri: direct
      parameters:
        name: testsend
      steps:
        - to:
            id: to-1378
            uri: log
            parameters:
              loggerName: testsend
              showAll: true
        - log:
            id: log-1906
            message: ${body}
